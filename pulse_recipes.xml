<?xml version="1.0"?>
<project default-recipe="unix_make">
    <property name="build.dir" value="_builds/${build.type}/"/>

    <macro name="prepare_build">
        <command name="create build directory">
            <executable exe="cmake" args="-E make_directory ${build.dir}"/>
        </command>
    </macro>

    <macro name="run_cmake">
        <command name="configure">
            <executable exe="cmake" working-dir="${build.dir}">
                <arg>-G</arg><arg>${cmake.generator}</arg>
                <arg>-D</arg><arg>CMAKE_BUILD_TYPE=${build.type}</arg>
                <arg>../../</arg>
            </executable>
        </command>
    </macro>

    <post-processor name="gcc_build.pp">
        <gcc.pp name="gcc.pp"/>
    </post-processor>

    <post-processor name="msvc_build.pp">
        <msbuild.pp name="msbuild.pp"/>
    </post-processor>

    <recipe name="unix_make">
        <macro-ref macro="${prepare_build}"/>

        <property name="cmake.generator" value="Unix Makefiles"/>
        <macro-ref macro="${run_cmake}"/>

        <command name="build">
            <make args="-j ${parallel.jobs}" working-dir="${build.dir}">
                <process processor="${gcc_build.pp}"/>
            </make>
        </command>

        <command name="test">
            <make targets="test" working-dir="${build.dir}"/>
        </command>
    </recipe>

    <recipe name="windows_nmake">
        <macro-ref macro="${prepare_build}"/>

        <property name="cmake.generator" value="NMake Makefile"/>
        <macro-ref macro="${run_cmake}"/>

        <command name="build">
            <executable exe="nmake.exe" working-dir="${build.dir}">
                <process processor="${msvc_build.pp}"/>
            </executable>
        </command>

        <command name="test">
            <executable exe="nmake.exe" args="test" working-dir="${build.dir}"/>
        </command>
    </recipe>

    <recipe name="windows_vcbuild">
        <macro-ref macro="${prepare_build}"/>

        <property name="cmake.generator" value="Visual Studio 9 2008"/>
        <macro-ref macro="${run_cmake}"/>

        <command name="build">
            <executable exe="${vcbuild.bin}" working-dir="${build.dir}">
                <arg>/M${parallel.jobs}</arg>
                <arg>PRO60.sln</arg>
                <arg>&quot;${build.type}|Win32&quot;</arg>

                <process processor="${msvc_build.pp}"/>
            </executable>
            <!--
            <executable exe="cmd.exe" working-dir="${build.dir}">
                <arg>/c</arg><arg>..\\..\\vcbuild_wrapper.bat</arg>

                <arg>/M${parallel.jobs}</arg>
                <arg>PRO60.sln</arg>
                <arg>&quot;${build.type}|Win32&quot;</arg>

                <process processor="${msvc_build.pp}"/>
            </executable>-->
        </command>

        <command name="test">
            <executable exe="vcbuild.exe" working-dir="${build.dir}">
                <arg>RUN_TESTS.vcproj</arg>
                <arg>&quot;${build.type}|Win32&quot;</arg>
            </executable>
        </command>
    </recipe>

</project>
