<?xml version="1.0"?>
<project default-recipe="unix_make">
    <macro name="prepare_build">
        <command name="create build directory">
            <executable exe="cmake" args="-E make_directory ${build.dir}"/>
        </command>
    </macro>

    <macro name="run_cmake">
        <command name="configure">
            <executable exe="cmake" working-dir="${build.dir}">
                <arg>-G</arg><arg>${cmake.generator}</arg>
                <arg>-D</arg><arg>CMAKE_VERBOSE_MAKEFILE=1</arg>
                <arg>-D</arg><arg>CMAKE_BUILD_TYPE=${build.type}</arg>
                <arg>../../</arg>
            </executable>
        </command>
    </macro>


    <post-processor name="cmake.pp">
        <regex.pp name="cmake_error.pp" trailing-context="10" fail-on-error="false">
            <pattern category="error" expression="^CMake Error"/>
        </regex.pp>
        <regex.pp name="cmake_warning.pp" trailing-context="10">
            <pattern category="warning" expression="CMake Warning"/>
        </regex.pp>
            <regex.pp name="cmake_config_warning.pp">
        <pattern category="warning" expression="^ -- Could NOT find"/>
        </regex.pp>
    </post-processor>

    <regex.pp name="ctest.pp">
        <pattern category="error" expression=".*\\*\\*\\*(Failed|Exception|Timeout|Bad command)"/>
    </regex.pp>

    <post-processor name="gcc_build.pp">
        <gcc.pp name="gcc.pp"/>
    </post-processor>

    <post-processor name="msvc_build.pp">
        <msbuild.pp name="msbuild.pp"/>
    </post-processor>

    <recipe name="unix_make">
        <property name="build.dir" value="_builds/${build.type}/"/>

        <macro-ref macro="${prepare_build}"/>

        <property name="cmake.generator" value="Unix Makefiles"/>
        <macro-ref macro="${run_cmake}"/>

        <command name="build">
            <make args="-j ${parallel.jobs} VERBOSE=1" working-dir="${build.dir}">
                <process processor="${gcc_build.pp}"/>
            </make>
        </command>

        <command name="test">
            <make targets="test" working-dir="${build.dir}"/>
        </command>
    </recipe>

    <recipe name="windows_nmake">
        <property name="build.dir" value="_builds/${build.type}/"/>
        <!-- TODO: make these agent properties -->
        <property name="vs.root.dir" value="${env.VS90COMNTOOLS}/../../"/>
        <property name="nmake.bin.dir" value="${vs.root.dir}/VC/bin/"/>
        <property name="nmake.bin" value="${nmake.bin.dir}/nmake.exe"/>

        <macro-ref macro="${prepare_build}"/>

        <property name="cmake.generator" value="NMake Makefile"/>
        <macro-ref macro="${run_cmake}"/>

        <command name="build">
            <executable exe="${nmake.bin}" working-dir="${build.dir}">
                <process processor="${msvc_build.pp}"/>
            </executable>
        </command>

        <command name="test">
            <executable exe="${nmake.bin}" args="test" working-dir="${build.dir}"/>
        </command>
    </recipe>

    <recipe name="windows_vcbuild">
        <property name="build.dir" value="_builds/"/>
        <!-- TODO: make these agent properties -->
        <property name="vs.root.dir" value="${env.VS90COMNTOOLS}/../../"/>
        <property name="vcbuild.bin.dir" value="${vs.root.dir}/VC/vcpackages/"/>
        <!-- <property name="vcbuild.bin" value="${vcbuild.bin.dir}/vcbuild.exe"/> -->

        <macro-ref macro="${prepare_build}"/>

        <property name="cmake.generator" value="Visual Studio 9 2008"/>
        <macro-ref macro="${run_cmake}"/>

        <command name="build">
            <executable exe="cmd.exe" working-dir="${build.dir}">
                <arg>/C</arg>
                <arg>..\\..\\vcbuild_wrapper.bat</arg>
                <arg>/M${parallel.jobs}</arg>
                <arg>PRO60.sln</arg>
                <arg>&quot;${build.type}|Win32&quot;</arg>

                <process processor="${msvc_build.pp}"/>
            </executable>
        </command>

        <!--
        <command name="build">
            <executable exe="${vcbuild.bin}" working-dir="${build.dir}">
                <arg>/M${parallel.jobs}</arg>
                <arg>PRO60.sln</arg>
                <arg>&quot;${build.type}|Win32&quot;</arg>

                <process processor="${msvc_build.pp}"/>
            </executable>
        </command>
        -->

        <command name="test">
            <executable exe="cmd.exe" working-dir="${build.dir}">
                <arg>/C</arg>
                <arg>..\\..\\vcbuild_wrapper.bat</arg>
                <arg>RUN_TESTS.vcproj</arg>
                <arg>&quot;${build.type}|Win32&quot;</arg>

                <process processor="${msvc_build.pp}"/>
            </executable>
        </command>
    </recipe>

    <recipe name="windows_incredibuild">
        <!-- TODO: make these agent properties -->
        <property name="vs.root.dir" value="${env.VS90COMNTOOLS}/../../"/>
        <property name="vcbuild.bin.dir" value="${vs.root.dir}/VC/vcpackages/"/>
        <property name="vcbuild.bin" value="${vcbuild.bin.dir}/vcbuild.exe"/>
        <property name="incredibuild.bin" value="BuildConsole.exe"/>

        <macro-ref macro="${prepare_build}"/>

        <property name="cmake.generator" value="Visual Studio 9 2008"/>
        <macro-ref macro="${run_cmake}"/>

        <command name="build">
            <executable exe="${incredibuild.bin}" working-dir="${build.dir}">
                <arg>PRO60.sln</arg>
                <arg>/CFG=&quot;${build.type}|Win32&quot;</arg>
                <arg>/SHOWCMD</arg>
                <arg>/SHOWAGENT</arg>

                <process processor="${msvc_build.pp}"/>
            </executable>
        </command>

        <command name="test">
            <executable exe="${vcbuild.bin}" working-dir="${build.dir}">
                <arg>RUN_TESTS.vcproj</arg>
                <arg>&quot;${build.type}|Win32&quot;</arg>
            </executable>
        </command>
    </recipe>
</project>
